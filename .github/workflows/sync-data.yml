name: Sync Pure API Data

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch for scripts
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run data sync
        env:
          PURE_API_KEY: ${{ secrets.PURE_API_KEY }}
          PURE_API_BASE_URL: https://vbn.aau.dk/ws/api/524
        run: npm run sync:data

      - name: Force push to data-storage orphan branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Copy data to temporary location
          cp -r data /tmp/data-backup

          # Create a new orphan branch (no history)
          git checkout --orphan data-storage-temp

          # Remove all tracked files from index
          git rm -rf .

          # Restore data from backup
          cp -r /tmp/data-backup ./data

          # Create README
          echo "# Data Storage Branch" > README.md
          echo "" >> README.md
          echo "This branch contains data files for the AAU Student Project Collaboration Portal." >> README.md
          echo "Updated: $(date '+%Y-%m-%d %H:%M UTC')" >> README.md

          # Add only data and README
          git add data/ README.md

          # Commit
          git commit -m "Update Pure API data $(date '+%Y-%m-%d %H:%M UTC')"

          # Force push to replace data-storage branch entirely
          git push origin data-storage-temp:data-storage --force
